# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.

# This workflow downloads and installs the latest version of Xanitizer, builds your project, runs a Xanitizer security analysis on it,
# and then archives the findings list reports and uploads the findings into the GitHub code scanning alert section of your repository.
#
# Documentation for the `RIGS-IT/xanitizer-action` is located here: https://github.com/RIGS-IT/xanitizer-action
#
# To use this basic workflow, you will need to complete the following setup steps:
#
# 1. The underlying Xanitizer, used in this workflow, needs a separate license file.
#    Licenses are free of charge for open source projects and for educational usage.
#    To get more information about the Xanitizer licenses and how to obtain a license file,
#    please consult https://www.xanitizer.com/xanitizer-pricing/.
#
# 2. The content of the license file has to be stored as a GitHub secret (e.g. XANITIZER_LICENSE) on this repository.
#    Please consult https://docs.github.com/en/actions/configuring-and-managing-workflows/creating-and-storing-encrypted-secrets for details.
#
# 3. Reference the GitHub secret in the step using the `RIGS-IT/xanitizer-action` GitHub action.
#    Example:
#    - name: Xanitizer Security Analysis
#      uses: RIGS-IT/xanitizer-action@v1
#      with:
#        license: ${{ secrets.XANITIZER_LICENSE }}
#
# 4. As a static application security testing (SAST) tool,
#    Xanitizer requires that all dependencies of the artifacts being analyzed can be resolved successfully.
#    So you have to install all used libraries and build your project before running the security analysis,
#    e.g. via `mvn compile` for Java or `npm install` for JavaScript

name: "Xanitizer Security Analysis"

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  schedule:
    - cron: "21 0 * * 0"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  xanitizer-security-analysis:
    permissions:
      contents: read
      security-events: write
      actions: read

    runs-on: ubuntu-latest

    steps:
      - name: üìÅ Checkout Code
        uses: actions/checkout@v4

      # Optional: If your project uses Node.js only
      - name: üîß Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      # Install JavaScript dependencies
      - name: üì¶ Install JavaScript Libraries
        run: npm install

      # Set TLS minimum version to avoid SSLv3 handshake errors
      - name: üîí Force TLS 1.2+
        run: echo "NODE_OPTIONS=--tls-min-v1.2" >> $GITHUB_ENV

      # Run Xanitizer Analysis
      - name: üõ°Ô∏è Run Xanitizer Security Analysis
        uses: RIGS-IT/xanitizer-action@87d13138fb113b727cbe040c744a15a2b4fe5316
        with:
          license: ${{ secrets.XANITIZER_LICENSE }}


      # Upload Reports as Artifacts
      - name: üì§ Upload Xanitizer Reports
        uses: actions/upload-artifact@v4
        with:
          name: Xanitizer-Reports
          path: |
            *-Findings-List.pdf
            *-Findings-List.sarif

      # Upload SARIF for GitHub Code Scanning
      - name: üìä Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: Xanitizer-Findings-List.sarif
